<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InDrive - –ê–Ω–∞–ª–∏–∑ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1 class="title">
                    –ê–Ω–∞–ª–∏–∑ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
                </h1>
                <p class="subtitle">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ª–∏—á–∏—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π</p>
            </div>
        </header>

        <main class="main">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content">
                        <div class="upload-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M17 8L12 3L7 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 3V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <h3 class="upload-title">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—é–¥–∞</h3>
                        <p class="upload-subtitle">–∏–ª–∏</p>
                        <button type="button" class="upload-btn" onclick="document.getElementById('fileInput').click()">
                            <span class="btn-icon">üìÅ</span>
                            –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª
                        </button>
                        <div class="file-info">
                            <p class="supported-formats">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, JPEG, PNG, GIF, BMP, WEBP, TIFF</p>
                            <p class="max-size">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10 –ú–ë</p>
                        </div>
                        <input type="file" id="fileInput" accept="image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/webp,image/tiff" style="display: none;">
                    </div>
                </div>
            </div>

            <div class="preview-section" id="previewSection" style="display: none;">
                <div class="preview-header">
                    <h3 class="preview-title">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
                    <div class="file-details" id="fileDetails"></div>
                </div>
                <div class="image-preview">
                    <img id="previewImage" alt="–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä">
                    <div class="image-overlay">
                        <div class="image-actions">
                            <button class="action-btn analyze-btn" onclick="analyzeImage()">
                                <span class="btn-icon">üîç</span>
                                –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button class="action-btn cancel-btn" onclick="cancelUpload()">
                                <span class="btn-icon">‚úï</span>
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="loading-section" id="loadingSection" style="display: none;">
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <h3 class="loading-title">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...</h3>
                    <p class="loading-subtitle">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</p>
                </div>
            </div>

            <div class="result-section" id="resultSection" style="display: none;">
                <div class="result-header">
                    <h3 class="result-title">–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞</h3>
                </div>
                <div class="result-content">
                    <div class="prediction" id="predictionResult"></div>
                    <div class="confidence" id="confidenceResult"></div>
                    <div class="probabilities" id="probabilitiesResult"></div>
                </div>
                <div class="result-actions">
                    <button class="action-btn new-analysis-btn" onclick="resetForm()">
                        <span class="btn-icon">üîÑ</span>
                        –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
                    </button>
                </div>
            </div>

            <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö -->
            <div class="notification" id="notification" style="display: none;">
                <div class="notification-content">
                    <span class="notification-icon" id="notificationIcon">‚ö†Ô∏è</span>
                    <span class="notification-message" id="notificationMessage"></span>
                    <button class="notification-close" onclick="hideNotification()">‚úï</button>
                </div>
            </div>
        </main>

        <footer>
            <p>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å ResNet18 –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π</p>
        </footer>
    </div>

    <script>
        let selectedFile = null;

        // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
        const SUPPORTED_FORMATS = [
            'image/jpeg',
            'image/jpg', 
            'image/png',
            'image/gif',
            'image/bmp',
            'image/webp',
            'image/tiff'
        ];

        // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (10MB)
        const MAX_FILE_SIZE = 10 * 1024 * 1024;

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ drag & drop
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
            if (!SUPPORTED_FORMATS.includes(file.type)) {
                showNotification('error', '–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: JPG, JPEG, PNG, GIF, BMP, WEBP, TIFF');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (10MB)
            if (file.size > MAX_FILE_SIZE) {
                showNotification('error', `–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: ${formatFileSize(MAX_FILE_SIZE)}`);
                return;
            }

            selectedFile = file;
            showPreview(file);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showPreview(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImage').src = e.target.result;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ —Ñ–∞–π–ª–∞
                const fileDetails = document.getElementById('fileDetails');
                fileDetails.innerHTML = `
                    <div class="file-detail">
                        <strong>–ò–º—è —Ñ–∞–π–ª–∞:</strong> ${file.name}
                    </div>
                    <div class="file-detail">
                        <strong>–†–∞–∑–º–µ—Ä:</strong> ${formatFileSize(file.size)}
                    </div>
                    <div class="file-detail">
                        <strong>–¢–∏–ø:</strong> ${file.type}
                    </div>
                `;
                
                // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é
                document.getElementById('previewSection').style.display = 'block';
                document.getElementById('uploadArea').style.display = 'none';
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
                setTimeout(() => {
                    document.getElementById('previewSection').style.opacity = '1';
                    document.getElementById('previewSection').style.transform = 'translateY(0)';
                }, 10);
            };
            reader.readAsDataURL(file);
        }

        function cancelUpload() {
            selectedFile = null;
            
            // –ü–ª–∞–≤–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –ø—Ä–µ–≤—å—é
            const previewSection = document.getElementById('previewSection');
            previewSection.style.opacity = '0';
            previewSection.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                previewSection.style.display = 'none';
                document.getElementById('uploadArea').style.display = 'block';
                fileInput.value = '';
            }, 300);
        }

        function analyzeImage() {
            if (!selectedFile) return;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
            setTimeout(() => {
                document.getElementById('loadingSection').style.opacity = '1';
                document.getElementById('loadingSection').style.transform = 'translateY(0)';
            }, 10);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const formData = new FormData();
            formData.append('file', selectedFile);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                showResult(data);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                showNotification('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
                resetForm();
            });
        }

        function showResult(data) {
            // –ü–ª–∞–≤–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingSection = document.getElementById('loadingSection');
            loadingSection.style.opacity = '0';
            loadingSection.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                loadingSection.style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                document.getElementById('resultSection').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('resultSection').style.opacity = '1';
                    document.getElementById('resultSection').style.transform = 'translateY(0)';
                }, 10);
            }, 300);
            
            const prediction = document.getElementById('predictionResult');
            const confidence = document.getElementById('confidenceResult');
            const probabilities = document.getElementById('probabilitiesResult');

            // –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
            prediction.innerHTML = `
                <div class="prediction-text ${data.prediction === '–ü–æ–≤—Ä–µ–∂–¥–µ–Ω' ? 'damage' : 'no-damage'}">
                    ${data.prediction === '–ü–æ–≤—Ä–µ–∂–¥–µ–Ω' ? '‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è' : '‚úÖ –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ'}
                </div>
            `;

            // –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
            confidence.innerHTML = `
                <div class="confidence-text">
                    –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: <span class="confidence-value">${(data.confidence * 100).toFixed(1)}%</span>
                </div>
            `;

            // –î–µ—Ç–∞–ª—å–Ω—ã–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
            probabilities.innerHTML = `
                <div class="probabilities-details">
                    <div class="prob-item">
                        <span class="prob-label">–ù–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω:</span>
                        <div class="prob-bar">
                            <div class="prob-fill" style="width: ${data.probabilities.no_damage * 100}%"></div>
                        </div>
                        <span class="prob-value">${(data.probabilities.no_damage * 100).toFixed(1)}%</span>
                    </div>
                    <div class="prob-item">
                        <span class="prob-label">–ü–æ–≤—Ä–µ–∂–¥–µ–Ω:</span>
                        <div class="prob-bar">
                            <div class="prob-fill damage" style="width: ${data.probabilities.damage * 100}%"></div>
                        </div>
                        <span class="prob-value">${(data.probabilities.damage * 100).toFixed(1)}%</span>
                    </div>
                </div>
            `;
        }

        function resetForm() {
            selectedFile = null;
            
            // –ü–ª–∞–≤–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π
            const sections = ['resultSection', 'previewSection'];
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section.style.display !== 'none') {
                    section.style.opacity = '0';
                    section.style.transform = 'translateY(20px)';
                    
                    setTimeout(() => {
                        section.style.display = 'none';
                    }, 300);
                }
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏
            setTimeout(() => {
                document.getElementById('uploadArea').style.display = 'block';
                fileInput.value = '';
            }, 300);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(type, message) {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const messageEl = document.getElementById('notificationMessage');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            switch(type) {
                case 'error':
                    icon.textContent = '‚ö†Ô∏è';
                    break;
                case 'success':
                    icon.textContent = '‚úÖ';
                    break;
                case 'warning':
                    icon.textContent = '‚ö†Ô∏è';
                    break;
                default:
                    icon.textContent = '‚ÑπÔ∏è';
            }
            
            messageEl.textContent = message;
            notification.style.display = 'block';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.style.display = 'none';
        }
    </script>
</body>
</html>
